<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Math Blocks ‚Äî Soustraire = transformer</title>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
  <div class="bgFX"><div class="blob b1"></div><div class="blob b2"></div><div class="blob b3"></div><div class="noise"></div></div>

  <div class="topbar">
    <div class="brand">
      <a class="badge" href="index.html" style="text-decoration:none;">‚Üê <span id="menuTxt">Menu</span></a>
      <span class="badge">‚ûñ <strong id="titleTxt">Soustraire = transformer</strong> <span class="small" id="subTxt">10 niveaux ‚Ä¢ 2 exercices</span></span>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="pill alt" id="langBtn" title="FR / NL">FR</button>
      <button class="pill" id="autoBtn" title="Aide automatique">ü§ñ Auto</button>
      <button class="pill" id="helpBtn"><span id="helpTxt">Aide</span></button>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="hd">
        <div style="width:100%">
          <p class="title"><span id="lvlLbl">Niveau</span> <span id="lvlNum">1</span> ¬∑ <span id="exLbl">Exercice</span> <span id="exNum">1</span>/2</p>
          <p class="sub" id="taskText"></p>
          <div class="progress" style="margin-top:10px" id="pb"><div></div></div>
        </div>
      </div>

      <div class="bd">
        <div class="gameShell">
          <div class="panel">
            <div class="eq">
              <span class="box"><span class="bigNumber" id="aNum">61</span></span>
              <span style="font-weight:900">‚àí</span>
              <span class="box"><span class="bigNumber" id="bNum">38</span></span>
              <span style="font-weight:900">=</span>
              <span class="box"><span class="bigNumber" id="resNum">?</span></span>
              <span class="tag warn" id="stepTag">√âtape</span>
            </div>

            <div class="blockStage" style="margin-top:14px;">
              <div class="blockBin">
                <h4 id="aTitle">Blocs du premier nombre (ce que j‚Äôai)</h4>
                <div class="blocksRow" id="aTensRow"></div>
                <div class="blocksRow" id="aOnesRow" style="margin-top:10px"></div>
              </div>
              <div class="blockBin">
                <h4 id="bTitle">Blocs √† retirer (ce que j‚Äôenl√®ve)</h4>
                <div class="blocksRow" id="bTensRow"></div>
                <div class="blocksRow" id="bOnesRow" style="margin-top:10px"></div>
              </div>
            </div>

            <div class="btnrow" style="margin-top:14px">
              <button class="btn warn" id="transformBtn">Transformer 1 dizaine ‚Üí 10 unit√©s</button>
              <button class="btn" id="removeOnesBtn">Retirer les unit√©s</button>
              <button class="btn" id="removeTensBtn">Retirer les dizaines</button>
            </div>

            <div class="btnrow" style="margin-top:14px">
              <button class="btn good" id="checkBtn">V√©rifier ‚úÖ</button>
              <button class="btn primary" id="nextBtn" disabled>Suivant ‚ñ∂</button>
            </div>

          </div>

          <div class="panel">
            <h3 id="explainHdr">Explication (niveau 1 = super clair)</h3>
            <p id="explainText"></p>

            <div class="helperBox" style="margin-top:12px;">
              <div class="hint" id="hintText"></div>
            </div>

            <div class="helperBox" style="margin-top:12px;">
              <div class="hint" id="proPhrase"></div>
            </div>

            <div class="card" style="margin-top:12px;">
              <div class="hd">
                <div>
                  <p class="title" style="font-size:16px" id="mapHdr">Carte des niveaux</p>
                  <p class="sub" style="font-size:13px" id="mapSub">Termine dans l‚Äôordre. Progression enregistr√©e.</p>
                </div>
              </div>
              <div class="bd">
                <div class="levelMap" id="levelMap"></div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { SUBTRACT_LEVELS } from "./js/data.js";
    import { loadProgress, saveProgress, toast, confettiBurst, renderBlocks, setProgressBar, splitNumber, clamp, animateShake, getLang, setLang, ensureBgFX, showIntro } from "./js/app.js";
    import { t } from "./js/i18n.js";

    ensureBgFX();

    const p = loadProgress();

    let currentLevel = 1;
    let currentExercise = 0;

    const lvlNum = document.getElementById("lvlNum");
    const exNum = document.getElementById("exNum");
    const taskText = document.getElementById("taskText");

    const aNumEl = document.getElementById("aNum");
    const bNumEl = document.getElementById("bNum");
    const resNumEl = document.getElementById("resNum");
    const stepTag = document.getElementById("stepTag");

    const aTensRow = document.getElementById("aTensRow");
    const aOnesRow = document.getElementById("aOnesRow");
    const bTensRow = document.getElementById("bTensRow");
    const bOnesRow = document.getElementById("bOnesRow");

    const explainText = document.getElementById("explainText");
    const hintText = document.getElementById("hintText");
    const proPhrase = document.getElementById("proPhrase");

    const transformBtn = document.getElementById("transformBtn");
    const removeOnesBtn = document.getElementById("removeOnesBtn");
    const removeTensBtn = document.getElementById("removeTensBtn");
    const checkBtn = document.getElementById("checkBtn");
    const nextBtn = document.getElementById("nextBtn");
    const autoBtn = document.getElementById("autoBtn");

    let step = 1;
    let A=0, B=0;
    let aT=0, aO=0;
    let bT=0, bO=0;
    let onesRemoved = false;
    let tensRemoved = false;

    // Language
    const langBtn = document.getElementById("langBtn");
    function applyLang(){
      const lang = getLang();
      langBtn.textContent = lang.toUpperCase();
      document.documentElement.lang = (lang === "nl") ? "nl" : "fr";

      document.getElementById("menuTxt").textContent = t(lang,"menu");
      document.getElementById("helpTxt").textContent = t(lang,"help");
      document.getElementById("lvlLbl").textContent = t(lang,"level");
      document.getElementById("exLbl").textContent = t(lang,"exercise");
      document.getElementById("titleTxt").textContent = (lang==="nl") ? "Aftrekken = veranderen" : "Soustraire = transformer";
      document.getElementById("subTxt").textContent = (lang==="nl") ? "10 niveaus ‚Ä¢ 2 oefeningen" : "10 niveaux ‚Ä¢ 2 exercices";

      document.getElementById("aTitle").textContent = (lang==="nl") ? "Blokjes van het eerste getal (wat ik heb)" : "Blocs du premier nombre (ce que j‚Äôai)";
      document.getElementById("bTitle").textContent = (lang==="nl") ? "Blokjes die ik wegneem (wat ik verwijder)" : "Blocs √† retirer (ce que j‚Äôenl√®ve)";

      transformBtn.textContent = t(lang,"transform");
      removeOnesBtn.textContent = (lang==="nl") ? "Eenheden wegnemen" : "Retirer les unit√©s";
      removeTensBtn.textContent = (lang==="nl") ? "Tientallen wegnemen" : "Retirer les dizaines";
      checkBtn.textContent = t(lang,"check");
      nextBtn.textContent = t(lang,"next");

      document.getElementById("mapHdr").textContent = (lang==="nl") ? "Niveaukaart" : "Carte des niveaux";
      document.getElementById("mapSub").textContent = (lang==="nl") ? "Volg de volgorde. Voortgang wordt opgeslagen." : "Termine dans l‚Äôordre. Progression enregistr√©e.";
      document.getElementById("explainHdr").textContent = (lang==="nl") ? "Uitleg (niveau 1 = super duidelijk)" : "Explication (niveau 1 = super clair)";

      proPhrase.innerHTML = (lang==="nl")
        ? "‚úÖ Korte zin: <strong>‚ÄúWe lenen niet: we veranderen om te kunnen wegnemen.‚Äù</strong>"
        : "‚úÖ Phrase courte : <strong>¬´ On ne pr√™te pas : on transforme pour pouvoir retirer. ¬ª</strong>";
    }
    langBtn.addEventListener("click", ()=>{
      setLang(getLang()==="fr" ? "nl" : "fr");
      applyLang();
      toast(getLang()==="nl" ? "Taal: NL ‚úÖ" : "Langue: FR ‚úÖ", "info");
      startExercise(true);
    });
    applyLang();

    function buildLevelMap(){
      const map = document.getElementById("levelMap");
      map.innerHTML = "";
      const maxUnlocked = getMaxUnlocked();
      for(let i=1;i<=10;i++){
        const done = !!p.subtract["L"+i];
        const locked = i>maxUnlocked;
        const b = document.createElement("div");
        b.className = "levelBtn" + (done ? " done" : "") + (locked ? " locked" : "");
        const lang = getLang();
        b.innerHTML = `<div class="n">${t(lang,"level")} ${i}</div><div class="s">${done?"‚úÖ":"‚Ä¢ 2"}</div>`;
        b.addEventListener("click", ()=>{
          if(locked){ toast(lang==="nl" ? "Eerst het vorige niveau üôÇ" : "Termine le niveau pr√©c√©dent üôÇ", "warn"); return; }
          currentLevel = i; currentExercise = 0;
          startExercise(true);
        });
        map.appendChild(b);
      }
    }

    function getMaxUnlocked(){
      let unlocked = 1;
      for(let i=1;i<=10;i++){
        if(p.subtract["L"+i]) unlocked = i+1;
        else break;
      }
      return clamp(unlocked, 1, 10);
    }

    function setHeaderProgress(){
      const done = Object.values(p.subtract).filter(Boolean).length;
      setProgressBar("pb", (done/10)*100);
    }

    function renderAll(){
      renderBlocks({tens:aT, ones:aO, tenRowEl:aTensRow, oneRowEl:aOnesRow, labelTen:"10", labelOne:"1"});
      renderBlocks({tens:bT, ones:bO, tenRowEl:bTensRow, oneRowEl:bOnesRow, labelTen:"10", labelOne:"1"});
      // playful wiggle when close to finish
      if(onesRemoved && !tensRemoved){
        aTensRow.classList.add("wiggle");
        setTimeout(()=>aTensRow.classList.remove("wiggle"), 380);
      }
    }

    function setExplain(){
      const lang = getLang();
      const needTransform = aO < bO;

      if(step===1){
        stepTag.textContent = t(lang,"step1");
        explainText.textContent = (lang==="nl")
          ? "Kijk naar de eenheden. Als je niet genoeg eenheden hebt, verander je 1 tiental in 10 eenheden."
          : "Regarde les unit√©s. Si tu n‚Äôas pas assez d‚Äôunit√©s, transforme 1 dizaine en 10 unit√©s.";
        hintText.textContent = needTransform
          ? (lang==="nl" ? "Tip: je mist eenheden. Klik op Transformeren." : "Astuce : il manque des unit√©s. Clique sur Transformer.")
          : (lang==="nl" ? "Tip: je hebt genoeg eenheden. Ga eenheden wegnemen." : "Astuce : tu as assez d‚Äôunit√©s. Retire les unit√©s.");
      }else if(step===2){
        stepTag.textContent = t(lang,"step2");
        explainText.textContent = (lang==="nl")
          ? `Neem nu de eenheden weg: neem ${bO} eenheden weg van het eerste getal.`
          : `Maintenant on retire les unit√©s : retire ${bO} unit√©s du premier nombre.`;
        hintText.textContent = (lang==="nl") ? "Klik: Eenheden wegnemen." : "Clique : Retirer les unit√©s.";
      }else{
        stepTag.textContent = t(lang,"step3");
        explainText.textContent = (lang==="nl")
          ? `Neem nu de tientallen weg: neem ${bT} tientallen weg.`
          : `Maintenant on retire les dizaines : retire ${bT} dizaines.`;
        hintText.textContent = (lang==="nl") ? "Klik: Tientallen wegnemen." : "Clique : Retirer les dizaines.";
      }
    }

    function startExercise(skipIntro=false){
      const levelData = SUBTRACT_LEVELS.find(x=>x.level===currentLevel);
      const ex = levelData.exercises[currentExercise];
      const lang = getLang();

      A = ex.a; B = ex.b;
      aNumEl.textContent = A;
      bNumEl.textContent = B;
      resNumEl.textContent = "?";

      lvlNum.textContent = currentLevel;
      exNum.textContent = (currentExercise+1);
      taskText.textContent = (ex.say && ex.say[lang]) ? ex.say[lang] : "";

      const sa = splitNumber(A);
      const sb = splitNumber(B);
      aT = sa.tens; aO = sa.ones;
      bT = sb.tens; bO = sb.ones;

      step = 1;
      onesRemoved = false;
      tensRemoved = false;
      nextBtn.disabled = true;

      renderAll();
      setExplain();
      setHeaderProgress();
      buildLevelMap();
      toast(t(lang,"stepByStep"), "info");

      // Intro only first time Level1 Ex1
      const introKey = "subIntroShown_v2";
      if(!skipIntro && currentLevel===1 && currentExercise===0 && !localStorage.getItem(introKey)){
        localStorage.setItem(introKey, "1");
        if(lang==="nl"){
          showIntro(`
            <h3 style="margin:0 0 8px">Niveau 1 ‚Äî Aftrekken met begrip</h3>
            <p>We zeggen niet <b>lenen</b>. We zeggen <b>veranderen</b>.</p>
            <p>Regel:</p>
            <ul>
              <li>Als je eenheden wilt wegnemen maar je hebt er te weinig ‚Üí <b>verander 1 tiental in 10 eenheden</b>.</li>
              <li>Daarna: <b>eerst eenheden</b>, dan <b>tientallen</b>.</li>
            </ul>
            <p>Gebruik de knoppen en leg elk stapje hardop uit üôÇ</p>
          `);
        }else{
          showIntro(`
            <h3 style="margin:0 0 8px">Niveau 1 ‚Äî Soustraire en comprenant</h3>
            <p>On ne dit pas <b>emprunter</b>. On dit <b>transformer</b>.</p>
            <p>R√®gle :</p>
            <ul>
              <li>Si tu veux retirer des unit√©s mais tu n‚Äôen as pas assez ‚Üí <b>transforme 1 dizaine en 10 unit√©s</b>.</li>
              <li>Ensuite : <b>d‚Äôabord les unit√©s</b>, puis <b>les dizaines</b>.</li>
            </ul>
            <p>Utilise les boutons et explique chaque √©tape √† voix haute üôÇ</p>
          `);
        }
      }
    }

    function transformOnce(){
      const lang = getLang();
      if(aT <= 0){
        animateShake(aTensRow.closest(".blockBin"));
        toast(lang==="nl" ? "Geen tientallen om te veranderen" : "Pas de dizaines √† transformer", "warn");
        return false;
      }
      aT -= 1;
      aO += 10;
      renderAll();
      toast(lang==="nl" ? "Verandering: 10 ‚Üí 10√ó1 ‚úÖ" : "Transformation : 10 ‚Üí 10√ó1 ‚úÖ", "info");
      setExplain();
      return true;
    }

    function removeOnes(){
      const lang = getLang();
      if(aO < bO){
        animateShake(aOnesRow.closest(".blockBin"));
        toast(lang==="nl" ? "Niet genoeg eenheden‚Ä¶ verander eerst" : "Pas assez d‚Äôunit√©s‚Ä¶ transforme d‚Äôabord", "warn");
        return false;
      }
      aO -= bO;
      onesRemoved = true;
      renderAll();
      toast(lang==="nl" ? "Eenheden weg ‚úÖ" : "Unit√©s retir√©es ‚úÖ", "good");
      step = 3;
      setExplain();
      return true;
    }

    function removeTens(){
      const lang = getLang();
      if(aT < bT){
        animateShake(aTensRow.closest(".blockBin"));
        toast(lang==="nl" ? "Niet genoeg tientallen (controleer stappen)" : "Pas assez de dizaines (v√©rifie)", "bad");
        return false;
      }
      aT -= bT;
      tensRemoved = true;
      renderAll();
      toast(lang==="nl" ? "Tientallen weg ‚úÖ" : "Dizaines retir√©es ‚úÖ", "good");
      return true;
    }

    transformBtn.addEventListener("click", ()=>{
      transformOnce();
      step = 2;
      setExplain();
    });

    removeOnesBtn.addEventListener("click", ()=>{
      step = 2;
      const ok = removeOnes();
      if(ok) step = 3;
      setExplain();
    });

    removeTensBtn.addEventListener("click", ()=>{
      step = 3;
      const ok = removeTens();
      if(ok){
        const result = aT*10 + aO;
        resNumEl.textContent = result;
        confettiBurst(80);
        nextBtn.disabled = false;
      }
      setExplain();
    });

    checkBtn.addEventListener("click", ()=>{
      const lang = getLang();
      const expected = A - B;
      const got = aT*10 + aO;
      if(onesRemoved && tensRemoved && got === expected){
        confettiBurst(120);
        toast(lang==="nl" ? "Perfect! ‚úÖ" : "Parfait ! ‚úÖ", "good");
        nextBtn.disabled = false;
      }else if(!onesRemoved || !tensRemoved){
        toast(lang==="nl" ? "Nog stappen te doen üôÇ (eenheden + tientallen)" : "Il manque des √©tapes üôÇ (unit√©s + dizaines)", "warn");
        animateShake(document.querySelector(".panel"));
      }else{
        toast(lang==="nl" ? "Bijna‚Ä¶ controleer wat je wegnam" : "Presque‚Ä¶ v√©rifie ce que tu as retir√©", "warn");
        animateShake(document.querySelector(".panel"));
      }
    });

    function markLevelIfDone(){
      if(currentExercise === 1){
        p.subtract["L"+currentLevel] = true;
        saveProgress(p);
        buildLevelMap();
        setHeaderProgress();
      }
    }

    nextBtn.addEventListener("click", ()=>{
      nextBtn.disabled = true;
      if(currentExercise < 1){
        currentExercise++;
        startExercise(true);
      }else{
        markLevelIfDone();
        if(currentLevel < 10){
          currentLevel++;
          currentExercise = 0;
          startExercise(true);
        }else{
          confettiBurst(180);
          toast(getLang()==="nl" ? "Alles afgerond! üèÜ" : "Tout termin√© ! üèÜ", "good");
        }
      }
    });

    // Auto helper
    autoBtn.addEventListener("click", ()=>{
      const lang = getLang();
      if(step===1){
        if(aO < bO) transformOnce();
        step = 2; setExplain();
        toast(lang==="nl" ? "Ok√©. Nu eenheden wegnemen." : "OK. Maintenant retire les unit√©s.", "info");
        return;
      }
      if(step===2){
        if(aO < bO){
          transformOnce();
          toast(lang==="nl" ? "Nog een verandering gedaan." : "J‚Äôai fait une transformation en plus.", "info");
        }else{
          removeOnes();
          toast(lang==="nl" ? "Eenheden weg. Nu tientallen." : "Unit√©s retir√©es. Maintenant les dizaines.", "info");
        }
        step = 3; setExplain();
        return;
      }
      if(step===3){
        removeTens();
        const result = aT*10 + aO;
        resNumEl.textContent = result;
        confettiBurst(90);
        toast(lang==="nl" ? "Klaar! Controleer ‚úÖ" : "Fini ! V√©rifie ‚úÖ", "good");
        nextBtn.disabled = false;
      }
    });

    document.getElementById("helpBtn").addEventListener("click", ()=>{
      toast(getLang()==="nl"
        ? "Gouden regel: als eenheden tekort zijn, verander 1 tiental in 10 eenheden."
        : "R√®gle d‚Äôor : si les unit√©s manquent, transforme 1 dizaine en 10 unit√©s.", "info");
    });

    // Start on first not-done level
    for(let i=1;i<=10;i++){
      if(!p.subtract["L"+i]){ currentLevel=i; break; }
    }
    startExercise(false);
  </script>
</body>
</html>
